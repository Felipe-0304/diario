<!DOCTYPE html>
<html lang="es" id="html-theme">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Pequeño Tesoro - Fotos y Videos</title>
    <meta name="theme-color" content="#FFB6C1">
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&family=Comic+Neue:wght@400;700&family=Roboto:wght@400;700&family=Open+Sans:wght@400;700&family=Dancing+Script:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/main.css">
    <style>
        :root {
            --color-primario: #FFB6C1;
            --color-secundario: #FFD1DC;
            --color-accento: #FFD700;
            --color-texto: #5D3B45;
            --color-texto-claro: #A78B94;
            --color-fondo: #FFF9FB;
            --color-tarjetas: #FFFFFF;
            --color-bordes: #F0D6DE;
            --color-error: #ff6b6b;
            --color-exito: #28a745;
            --fuente-principal: 'Comic Neue', cursive;
            --tamano-fuente: 16px;
        }

        body {
            font-family: var(--fuente-principal);
            background-color: var(--color-fondo);
            color: var(--color-texto);
            margin: 0;
            padding: 0;
            line-height: 1.6;
            font-size: var(--tamano-fuente);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            position: relative;
        }

        h1 {
            font-family: 'Pacifico', cursive;
            color: var(--color-primario);
            font-size: 2.5rem;
            margin-bottom: 20px;
        }
        .seccion-galeria {
            background-color: var(--color-tarjetas);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.05);
            border: 1px solid var(--color-bordes);
        }
        
        .controles-galeria {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .form-media { display: flex; flex-direction: column; gap: 20px; }
        .form-group { display: flex; flex-direction: column; gap: 8px; }
        .form-group label { font-weight: bold; font-size: 0.95rem; }
        .form-control { width: 100%; padding: 12px; border: 1px solid var(--color-bordes); border-radius: 10px; font-family: var(--fuente-principal); background-color: var(--color-fondo); color: var(--color-texto); transition: all 0.3s; box-sizing: border-box; font-size: 1rem; }
        .form-control:focus { outline: none; border-color: var(--color-primario); box-shadow: 0 0 0 2px var(--color-secundario); }
        .form-group textarea { resize: vertical; min-height: 100px; }
        #preview-container { margin-top: 15px; text-align: center; }
        #media-preview { max-width: 100%; max-height: 300px; border-radius: 8px; border: 1px solid var(--color-bordes); object-fit: contain; }
        #media-preview:empty { display: none; }
        .form-actions { display: flex; justify-content: flex-end; margin-top: 20px; gap: 10px; }
        .btn { padding: 12px 25px; border: none; border-radius: 25px; font-family: var(--fuente-principal); font-weight: bold; cursor: pointer; transition: all 0.3s; }
        .btn-primario { background-color: var(--color-primario); color: white; }
        .btn-primario:hover { opacity: 0.8; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .btn-secundario { background-color: var(--color-texto-claro); color: white; }
        .btn-secundario:hover { background-color: var(--color-texto); transform: translateY(-2px); }

        /* Galería */
        .galeria-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; margin-top: 30px; }
        .galeria-item { background-color: var(--color-fondo); border-radius: 10px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.1); border: 1px solid var(--color-bordes); position: relative; aspect-ratio: 1 / 1; transition: all 0.3s ease; transform: scale(1); }
        .galeria-item:hover { transform: scale(1.03); box-shadow: 0 5px 15px rgba(0,0,0,0.1); z-index: 1; }
        .galeria-item img, .galeria-item video { width: 100%; height: 100%; object-fit: cover; display: block; transition: transform 0.3s ease; }
        .galeria-item:hover img, .galeria-item:hover video { transform: scale(1.05); }
        .galeria-item .info { position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(to top, rgba(0,0,0,0.7) 0%, rgba(0,0,0,0) 100%); color: white; padding: 15px; font-size: 0.85rem; opacity: 0; transition: opacity 0.3s ease; }
        .galeria-item:hover .info { opacity: 1; }
        .galeria-item .info h3 { margin: 0 0 5px 0; font-size: 0.95rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .galeria-item .info p { margin: 0; font-size: 0.75rem; }
        .galeria-item .media-type-icon { position: absolute; top: 10px; right: 10px; font-size: 1.5rem; color: white; background-color: rgba(0,0,0,0.3); border-radius: 50%; padding: 5px; display: none; }
        .galeria-item.video .media-type-icon { display: block; }
        .galeria-acciones { position: absolute; top: 10px; left: 10px; display: flex; gap: 5px; opacity: 0; transition: opacity 0.3s; z-index: 10; }
        .galeria-item:hover .galeria-acciones { opacity: 1; }
        .galeria-acciones button { background-color: rgba(0,0,0,0.5); color: white; border: none; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.3s; }
        .galeria-acciones button:hover { background-color: rgba(0,0,0,0.8); transform: scale(1.1); }
        .galeria-acciones .btn-favorito.favorito { color: var(--color-accento); }

        /* Filtros */
        #galeria-filtros { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .btn-filter { padding: 8px 16px; background-color: var(--color-fondo); color: var(--color-texto); border: 1px solid var(--color-bordes); }
        .btn-filter.active { background-color: var(--color-primario); color: white; border-color: var(--color-primario); }

        /* MODO PRESENTACIÓN MEJORADO */
        #fullscreen-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.9); z-index: 2000; flex-direction: column; align-items: center; justify-content: center; }
        #fs-media-container { position: relative; max-width: 90%; max-height: 80vh; text-align: center; transition: opacity 0.4s ease-in-out; }
        .media-fullscreen { max-width: 100%; max-height: 80vh; object-fit: contain; border-radius: 5px; box-shadow: 0 0 30px rgba(0,0,0,0.5); }
        #fs-descripcion { color: white; margin-top: 15px; text-align: center; max-width: 70%; font-size: 1.1rem; transition: opacity 0.4s ease-in-out; }
        .fs-controles-navegacion { position: absolute; top: 50%; width: 100%; left: 0; transform: translateY(-50%); display: flex; justify-content: space-between; padding: 0 10px; box-sizing: border-box; pointer-events: none; }
        .fs-controles-navegacion button { pointer-events: all; font-size: 2.5rem; background-color: rgba(255,255,255,0.1); border-radius: 50%; width: 50px; height: 50px; line-height: 50px; text-align: center; border: none; color: white; cursor: pointer; transition: all 0.2s; }
        .fs-controles-barra { position: absolute; bottom: 20px; display: flex; gap: 15px; background-color: rgba(0,0,0,0.3); padding: 10px 20px; border-radius: 30px; }
        #fs-cerrar { position: absolute; top: 20px; right: 20px; }
        .fs-controles-barra button, #fs-cerrar { background: none; border: none; color: white; cursor: pointer; font-size: 1.8rem; transition: transform 0.2s, color 0.2s; }
        .fs-controles-barra button:hover, #fs-cerrar:hover, .fs-controles-navegacion button:hover { transform: scale(1.1); color: var(--color-primario); }
        .fs-controles-navegacion button:disabled { opacity: 0.3; pointer-events: none; }
        #btn-fs-play.playing #play-icon { display: none; }
        #btn-fs-play:not(.playing) #pause-icon { display: none; }

        /* Modal para Añadir/Editar Recuerdo */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; padding: 15px; box-sizing: border-box; }
        .modal-contenido { background-color: var(--color-tarjetas); padding: 30px; border-radius: 15px; width: 90%; max-width: 500px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); border: 1px solid var(--color-bordes); max-height: 90vh; overflow-y: auto; }
        .modal-contenido h2 { font-family: 'Pacifico', cursive; color: var(--color-primario); margin-top: 0; margin-bottom: 20px; text-align: center; }
        
        footer { text-align: center; margin-top: 50px; padding-top: 20px; border-top: 1px solid var(--color-bordes); color: var(--color-texto-claro); font-size: 0.9rem; }

        /* Estilo para el indicador de diario activo */
        .diario-activo-fotos-info {
            text-align: right;
            margin-bottom: 10px;
            font-size: 0.85em;
            color: var(--color-texto-claro);
        }
        .diario-activo-fotos-info strong {
            color: var(--color-texto);
            font-weight: bold;
        }

    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>📷 Fotos y Videos</h1>
            <button id="btn-logout" title="Cerrar sesión" style="position: absolute; top: 20px; right: 20px; background: none; border: none; cursor: pointer; font-size: 1.5rem; color: var(--color-primario);">👋</button>
            <nav>
                <ul>
                    <li><a href="index.html">🏠 Inicio</a></li>
                    <li><a href="fotos.html" class="active">📷 Fotos</a></li>
                    <li><a href="calendario.html">📅 Calendario</a></li>
                    <li><a href="linea-tiempo.html">⏳ Línea de Tiempo</a></li>
                    <li><a href="configuracion.html">⚙️ Configuración</a></li>
                </ul>
            </nav>
        </header>

        <section class="seccion-galeria">
            <div class="diario-activo-fotos-info" id="diario-activo-fotos-info" style="display:none;">
                Mostrando recuerdos del diario: <strong id="nombre-diario-actual-fotos">Cargando...</strong>
            </div>
            <h2>Mis Recuerdos Multimedia</h2>
            <div id="global-gallery-message" class="mensaje" style="display:none;"></div>
            
            <div class="controles-galeria">
                <button id="btn-nuevo-recuerdo" class="btn btn-primario">+ Añadir Nuevo Recuerdo</button>
                <button id="btn-iniciar-presentacion" class="btn btn-secundario" disabled>▶️ Iniciar Presentación</button>
            </div>
            
            <div id="galeria-filtros">
                <button class="btn btn-filter active" data-filter="all">Todos</button>
                <button class="btn btn-filter" data-filter="foto">Solo Fotos</button>
                <button class="btn btn-filter" data-filter="video">Solo Videos</button>
                <button class="btn btn-filter" data-filter="favoritos">Favoritos</button>
            </div>
            
            <div class="galeria-grid" id="galeria-grid-items">
                <p class="mensaje mensaje-carga">Cargando recuerdos...</p>
            </div>
        </section>
        
        <div id="fullscreen-overlay">
            <button id="fs-cerrar" title="Cerrar (Esc)">✖️</button>
            <div id="fs-media-container"></div>
            <p id="fs-descripcion"></p>

            <div class="fs-controles-navegacion">
                <button id="fs-anterior" title="Anterior (←)">❮</button>
                <button id="fs-siguiente" title="Siguiente (→)">❯</button>
            </div>

            <div class="fs-controles-barra">
                <button id="btn-fs-play" title="Reproducir/Pausar (Espacio)">
                    <span id="play-icon">▶️</span>
                    <span id="pause-icon">⏸️</span>
                </button>
                <button id="btn-fs-fullscreen" title="Pantalla Completa (F)">🖼️</button>
            </div>
        </div>

        <div id="modal-edicion" class="modal">
            <div class="modal-contenido">
                <h2>Editar Recuerdo</h2>
                <div id="edit-modal-message" class="mensaje" style="display:none;"></div>
                <form id="form-edicion" novalidate>
                    <input type="hidden" id="edicion-id">
                    <input type="hidden" id="edicion-diario-id"> <!-- Campo oculto para el ID del diario del evento -->
                    <div class="form-group">
                        <label for="edicion-titulo">Título:</label>
                        <input type="text" id="edicion-titulo" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="edicion-fecha">Fecha:</label>
                        <input type="date" id="edicion-fecha" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="edicion-descripcion">Descripción:</label>
                        <textarea id="edicion-descripcion" class="form-control" rows="3"></textarea>
                    </div>
                     <div class="form-group">
                        <label for="edicion-media-file">Reemplazar Archivo (opcional):</label>
                        <input type="file" id="edicion-media-file" class="form-control" accept="image/*,video/mp4,video/quicktime,video/webm,video/x-matroska">
                        <small>Si seleccionas un nuevo archivo, el anterior será reemplazado.</small>
                    </div>
                    <div id="edicion-preview-container" style="margin-top:10px; text-align:center;">
                        <small>Archivo actual:</small><br>
                        <span id="edicion-current-media-info">Ninguno</span>
                    </div>
                    <div class="form-group checkbox-container">
                        <input type="checkbox" id="edicion-favorito" class="visually-hidden">
                        <label for="edicion-favorito" class="checkbox-custom" aria-hidden="true"></label>
                        <label for="edicion-favorito" class="checkbox-label-text">Marcar como favorito</label>
                    </div>
                    <div class="form-actions">
                        <button type="button" id="btn-cancelar-edicion" class="btn btn-secundario">Cancelar</button>
                        <button type="submit" class="btn btn-primario">Guardar Cambios</button>
                    </div>
                </form>
            </div>
        </div>
        
        <div id="modal-nuevo-recuerdo" class="modal">
            <div class="modal-contenido">
                <h2>Añadir Nuevo Recuerdo</h2>
                <form id="form-media" novalidate>
                    <!-- Campo oculto para el ID del diario activo -->
                    <input type="hidden" id="nuevo-recuerdo-diario-id" name="diarioId">
                    <div class="form-group">
                        <label for="media-file">Seleccionar Archivo (Imagen o Video):</label>
                        <input type="file" id="media-file" name="mediaFile" class="form-control" accept="image/*,video/mp4,video/quicktime,video/webm,video/x-matroska" required>
                        <small>Formatos: JPG, PNG, GIF, MP4, MOV, WEBM, MKV. Máx. 25MB</small>
                    </div>
                    <div id="preview-container"></div> <div class="form-group">
                        <label for="media-titulo">Título:</label>
                        <input type="text" id="media-titulo" name="titulo" class="form-control" placeholder="Ej: Primer día en el parque" required>
                    </div>
                    <div class="form-group">
                        <label for="media-fecha">Fecha:</label>
                        <input type="date" id="media-fecha" name="fecha" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="media-descripcion">Descripción (opcional):</label>
                        <textarea id="media-descripcion" name="descripcion" class="form-control" rows="3" placeholder="Cuenta la historia..."></textarea>
                    </div>
                    <div class="form-group checkbox-container">
                        <input type="checkbox" id="media-favorito" name="favorito" class="visually-hidden">
                        <label for="media-favorito" class="checkbox-custom" aria-hidden="true"></label>
                        <label for="media-favorito" class="checkbox-label-text">Marcar como favorito</label>
                    </div>
                    <div id="upload-message-container">
                        <div id="upload-message" class="mensaje" style="display:none;"></div>
                    </div>
                    <div class="form-actions">
                        <button type="button" id="btn-cancelar-subida" class="btn btn-secundario">Cancelar</button>
                        <button type="submit" class="btn btn-primario" id="btn-guardar-media">Guardar Recuerdo</button>
                    </div>
                </form>
            </div>
        </div>

        <footer>
            <p>&copy; <span id="current-year"></span> Con todo el amor del mundo - Diario de Mi Bebé </p>
        </footer>
    </div>

    <script src="/js/theme-manager.js" defer></script>
    <script src="/js/utils.js" defer></script>
    <script>
    // getActiveDiarioId, setActiveDiarioId, fetchAPI, cerrarSesion, mostrarMensajeGlobal, etc. vienen de utils.js
    document.addEventListener('DOMContentLoaded', async function() {
        // --- DECLARACIÓN DE ELEMENTOS DEL DOM ---
        const galeriaGridItems = document.getElementById('galeria-grid-items');
        const btnLogout = document.getElementById('btn-logout');
        const globalGalleryMessageEl = document.getElementById('global-gallery-message');
        const diarioActivoInfoEl = document.getElementById('diario-activo-fotos-info');
        const nombreDiarioActualEl = document.getElementById('nombre-diario-actual-fotos');


        // Controles de la galería
        const btnNuevoRecuerdo = document.getElementById('btn-nuevo-recuerdo');
        const btnIniciarPresentacion = document.getElementById('btn-iniciar-presentacion');

        // Modal para añadir recuerdo
        const modalNuevoRecuerdo = document.getElementById('modal-nuevo-recuerdo');
        const formMedia = document.getElementById('form-media');
        const mediaFileInput = document.getElementById('media-file');
        const previewContainer = document.getElementById('preview-container');
        const uploadMessageEl = document.getElementById('upload-message');
        const btnCancelarSubida = document.getElementById('btn-cancelar-subida');
        const nuevoRecuerdoDiarioIdInput = document.getElementById('nuevo-recuerdo-diario-id'); // Para el ID del diario

        // Modal para editar recuerdo
        const modalEdicion = document.getElementById('modal-edicion');
        const formEdicion = document.getElementById('form-edicion');
        const editModalMessageEl = document.getElementById('edit-modal-message');
        const edicionIdInput = document.getElementById('edicion-id');
        const edicionDiarioIdInput = document.getElementById('edicion-diario-id'); // Para el ID del diario del evento a editar
        const edicionTituloInput = document.getElementById('edicion-titulo');
        const edicionFechaInput = document.getElementById('edicion-fecha');
        const edicionDescripcionInput = document.getElementById('edicion-descripcion');
        const edicionFavoritoInput = document.getElementById('edicion-favorito');
        const edicionMediaFileInput = document.getElementById('edicion-media-file');
        const edicionCurrentMediaInfoEl = document.getElementById('edicion-current-media-info');
        const btnCancelarEdicion = document.getElementById('btn-cancelar-edicion');
        
        // Elementos de Presentación (Fullscreen)
        const fullscreenOverlay = document.getElementById('fullscreen-overlay');
        const fsMediaContainer = document.getElementById('fs-media-container');
        const fsDescripcionEl = document.getElementById('fs-descripcion');
        const btnFsCerrar = document.getElementById('fs-cerrar');
        const btnFsAnterior = document.getElementById('fs-anterior');
        const btnFsSiguiente = document.getElementById('fs-siguiente');
        const btnFsPlay = document.getElementById('btn-fs-play');
        const btnFsFullscreen = document.getElementById('btn-fs-fullscreen');
        
        // --- ESTADO DE LA APLICACIÓN ---
        let currentActiveDiarioId = null;
        let allServerEvents = []; // Eventos del diario activo
        let fullscreenableItems = [];
        let currentMediaFilter = 'all';
        let currentFsIndex = 0;
        let slideshowInterval = null;

        // --- DEFINICIÓN DE FUNCIONES ---
        async function inicializarPaginaFotos() {
            currentActiveDiarioId = getActiveDiarioId();

            if (!currentActiveDiarioId) {
                mostrarMensajeGlobal('No hay un diario activo seleccionado. Por favor, ve a la página de inicio.', 'error', globalGalleryMessageEl);
                if(btnNuevoRecuerdo) btnNuevoRecuerdo.disabled = true;
                if(galeriaGridItems) galeriaGridItems.innerHTML = '<p class="mensaje mensaje-vacio">Selecciona un diario para ver sus recuerdos.</p>';
                if(diarioActivoInfoEl) diarioActivoInfoEl.style.display = 'none';
                // Podríamos redirigir a index.html si preferimos que allí se maneje la selección/creación inicial
                // window.location.href = 'index.html';
                return;
            }

            if(btnNuevoRecuerdo) btnNuevoRecuerdo.disabled = false;
            if(nuevoRecuerdoDiarioIdInput) nuevoRecuerdoDiarioIdInput.value = currentActiveDiarioId; // Pre-rellenar para el formulario de nuevo recuerdo

            // Mostrar info del diario activo
            if (diarioActivoInfoEl && nombreDiarioActualEl) {
                try {
                    const configDiario = await fetchAPI('/api/configuracion'); // Asume que esto devuelve la config del diario activo
                    if (configDiario && configDiario.nombre_diario_personalizado) {
                        nombreDiarioActualEl.textContent = configDiario.nombre_diario_personalizado;
                    } else {
                        nombreDiarioActualEl.textContent = `Diario ID: ${currentActiveDiarioId}`;
                    }
                    diarioActivoInfoEl.style.display = 'block';
                } catch (error) {
                    console.warn("No se pudo cargar el nombre del diario activo:", error.message);
                    nombreDiarioActualEl.textContent = `Diario ID: ${currentActiveDiarioId}`;
                    diarioActivoInfoEl.style.display = 'block';
                }
            }
            
            await cargarYRenderizarGaleria();
        }


        function abrirModalRecuerdo() { 
            if (!currentActiveDiarioId) {
                mostrarMensajeGlobal('Debes tener un diario activo para añadir recuerdos.', 'error', globalGalleryMessageEl, 3000);
                return;
            }
            if (modalNuevoRecuerdo) {
                if(formMedia) formMedia.reset();
                if(previewContainer) previewContainer.innerHTML = '';
                if(uploadMessageEl) mostrarMensajeGlobal('', '', uploadMessageEl);
                if(nuevoRecuerdoDiarioIdInput) nuevoRecuerdoDiarioIdInput.value = currentActiveDiarioId; // Asegurar que esté seteado
                modalNuevoRecuerdo.style.display = 'flex'; 
            }
        }
        function cerrarModalRecuerdo() {
            if (modalNuevoRecuerdo) modalNuevoRecuerdo.style.display = 'none';
            if (formMedia) formMedia.reset();
            if (previewContainer) previewContainer.innerHTML = '';
            if(uploadMessageEl) mostrarMensajeGlobal('', '', uploadMessageEl);
        }
        function abrirModalEdicion(item) {
            if (!modalEdicion || !edicionIdInput || !item) return; 
            edicionIdInput.value = item.id;
            if(edicionDiarioIdInput) edicionDiarioIdInput.value = item.diario_id; // Guardar el diario_id del evento
            if(edicionTituloInput) edicionTituloInput.value = item.titulo;
            if(edicionFechaInput) edicionFechaInput.value = item.fecha;
            if(edicionDescripcionInput) edicionDescripcionInput.value = item.descripcion || '';
            if(edicionFavoritoInput) edicionFavoritoInput.checked = Boolean(item.favorito);
            if(edicionMediaFileInput) edicionMediaFileInput.value = ''; // Limpiar input de archivo
            
            if(edicionCurrentMediaInfoEl) {
                if (item.media_url) {
                    edicionCurrentMediaInfoEl.innerHTML = `Archivo actual: <a href="${item.media_url}" target="_blank">${item.tipo === 'video' ? 'Video' : 'Imagen'}</a>`;
                } else {
                    edicionCurrentMediaInfoEl.textContent = 'Sin archivo multimedia adjunto.';
                }
            }

            if (editModalMessageEl) editModalMessageEl.style.display = 'none';
            modalEdicion.style.display = 'flex';
            if (edicionTituloInput) edicionTituloInput.focus();
        }
        function cerrarModalEdicion() {
            if (modalEdicion) modalEdicion.style.display = 'none';
            if (formEdicion) formEdicion.reset();
        }

        function abrirPresentacion(startIndex) {
            if (fullscreenableItems.length === 0) {
                mostrarMensajeGlobal('No hay nada para presentar.', 'info', globalGalleryMessageEl, 3000);
                return;
            }
            currentFsIndex = startIndex;
            if(fullscreenOverlay) fullscreenOverlay.style.display = 'flex';
            document.body.style.overflow = 'hidden';
            mostrarMediaEnPresentacion(currentFsIndex);
        }
        function cerrarPresentacion() {
            if(fullscreenOverlay) fullscreenOverlay.style.display = 'none';
            document.body.style.overflow = '';
            if(fsMediaContainer) fsMediaContainer.innerHTML = '';
            detenerSlideshow();
            if (document.fullscreenElement) document.exitFullscreen().catch(err => console.warn("Error al salir de pantalla completa:", err));
        }
        function avanzarSlide() {
            if (fullscreenableItems.length === 0) { 
                detenerSlideshow();
                return;
            }
            const newIndex = (currentFsIndex + 1) % fullscreenableItems.length;
            mostrarMediaEnPresentacion(newIndex);
        }
        function iniciarSlideshow() {
            if (slideshowInterval || fullscreenableItems.length === 0) return;
            if(btnFsPlay) btnFsPlay.classList.add('playing');
            slideshowInterval = setInterval(avanzarSlide, 5000);
        }
        function detenerSlideshow() {
            clearInterval(slideshowInterval);
            slideshowInterval = null;
            if(btnFsPlay) btnFsPlay.classList.remove('playing');
        }
        function toggleSlideshow() {
            if (slideshowInterval) detenerSlideshow();
            else iniciarSlideshow();
        }
        function toggleVerdaderoFullscreen() {
            if (!document.fullscreenElement && fullscreenOverlay) {
                 fullscreenOverlay.requestFullscreen().catch(err => alert(`Error al entrar en pantalla completa: ${err.message}`));
            } else if (document.fullscreenElement) {
                 document.exitFullscreen().catch(err => console.warn("Error al salir de pantalla completa:", err));
            }
        }
        function mostrarMediaEnPresentacion(index) {
            if (index < 0 || index >= fullscreenableItems.length || !fsMediaContainer || !fsDescripcionEl) return;
            detenerSlideshow();
            const item = fullscreenableItems[index];
            currentFsIndex = index;
            fsMediaContainer.style.opacity = 0;
            fsDescripcionEl.style.opacity = 0;
            setTimeout(() => {
                fsMediaContainer.innerHTML = '';
                let mediaElementFs;
                if (item.tipo === 'video' && item.media_url) {
                    mediaElementFs = document.createElement('video');
                    mediaElementFs.src = item.media_url;
                    mediaElementFs.controls = true;
                    mediaElementFs.autoplay = true;
                } else if (item.tipo === 'foto' && item.media_url) {
                    mediaElementFs = document.createElement('img');
                    mediaElementFs.src = item.media_url;
                    mediaElementFs.alt = item.titulo;
                } else {
                     fsMediaContainer.innerHTML = "<p>No se puede mostrar el medio.</p>"; return;
                }
                mediaElementFs.className = 'media-fullscreen';
                fsMediaContainer.appendChild(mediaElementFs);
                fsDescripcionEl.innerHTML = `<strong>${item.titulo}</strong> <span>(${new Date(item.fecha + 'T00:00:00').toLocaleDateString('es-ES', { timeZone: 'UTC' })})</span>`;
                if(item.descripcion) fsDescripcionEl.innerHTML += `<p style="font-size: 0.9em; margin-top: 5px;">${item.descripcion}</p>`;
                fsMediaContainer.style.opacity = 1;
                fsDescripcionEl.style.opacity = 1;
            }, 300); // Pequeña demora para la transición de opacidad
            if(btnFsAnterior) btnFsAnterior.disabled = index === 0;
            if(btnFsSiguiente) btnFsSiguiente.disabled = index === fullscreenableItems.length - 1;
        }

        async function cargarYRenderizarGaleria() {
            if(!galeriaGridItems || !currentActiveDiarioId) return;
            galeriaGridItems.innerHTML = '<p class="mensaje mensaje-carga">Cargando recuerdos del diario...</p>';
            try {
                // Usar el endpoint que filtra por diarioId
                const eventos = await fetchAPI(`/api/eventos/diario/${currentActiveDiarioId}`);
                allServerEvents = Array.isArray(eventos) ? eventos.map(e => ({...e, favorito: Boolean(e.favorito)})) : [];
                renderizarGaleriaFiltrada();
            } catch (error) {
                console.error("Error cargando recuerdos para el diario " + currentActiveDiarioId + ":", error);
                if (error.message !== 'No autorizado' && globalGalleryMessageEl) {
                     mostrarMensajeGlobal(`Error al cargar: ${error.message}`, 'error', globalGalleryMessageEl);
                } else if (error.message !== 'No autorizado') {
                     galeriaGridItems.innerHTML = `<p class="mensaje mensaje-error">Error al cargar: ${error.message}</p>`;
                }
            }
        }
        function renderizarGaleriaFiltrada() {
            if(!galeriaGridItems) return;
            let itemsParaGaleria = allServerEvents.filter(e => (e.tipo === 'foto' || e.tipo === 'video') && e.media_url);
            if (currentMediaFilter === 'foto') itemsParaGaleria = itemsParaGaleria.filter(item => item.tipo === 'foto');
            else if (currentMediaFilter === 'video') itemsParaGaleria = itemsParaGaleria.filter(item => item.tipo === 'video');
            else if (currentMediaFilter === 'favoritos') itemsParaGaleria = itemsParaGaleria.filter(item => item.favorito);
            
            fullscreenableItems = itemsParaGaleria.sort((a,b) => new Date(b.fecha + (b.created_at || 'T00:00:00Z')) - new Date(a.fecha + (a.created_at || 'T00:00:00Z')));
            if(btnIniciarPresentacion) btnIniciarPresentacion.disabled = fullscreenableItems.length === 0;
            
            galeriaGridItems.innerHTML = '';
            if (fullscreenableItems.length === 0) {
                const tipoMsg = currentMediaFilter === 'all' ? 'recuerdos multimedia' : (currentMediaFilter === 'foto' ? 'fotos' : (currentMediaFilter === 'video' ? 'videos' : 'favoritos'));
                galeriaGridItems.innerHTML = `<p class="mensaje mensaje-vacio">No hay ${tipoMsg} aún en este diario. ¡Añade algunos!</p>`;
                return;
            }
            fullscreenableItems.forEach(item => {
                const galeriaItem = document.createElement('div');
                galeriaItem.className = `galeria-item ${item.tipo}`;
                galeriaItem.dataset.id = item.id; // ID del evento
                const mediaElement = item.tipo === 'video' ? `<video src="${item.media_url}#t=0.5" preload="metadata"></video>` : `<img src="${item.media_url}" alt="${item.titulo}" loading="lazy">`;
                galeriaItem.innerHTML = `
                    ${mediaElement}
                    ${item.tipo === 'video' ? '<span class="media-type-icon">▶️</span>' : ''}
                    <div class="info"><h3>${item.titulo}</h3><p>${new Date(item.fecha + 'T00:00:00').toLocaleDateString('es-ES', { timeZone: 'UTC' })}</p></div>
                    <div class="galeria-acciones">
                        <button class="btn-favorito ${item.favorito ? 'favorito' : ''}" data-id="${item.id}" title="Favorito">${item.favorito ? '★' : '☆'}</button>
                        <button class="btn-editar" data-id="${item.id}" title="Editar">✏️</button>
                        <button class="btn-eliminar" data-id="${item.id}" title="Eliminar">🗑️</button>
                    </div>`;
                galeriaGridItems.appendChild(galeriaItem);
            });
        }
        async function guardarCambiosEdicion(event) {
            event.preventDefault();
            if (!formEdicion || !formEdicion.checkValidity() || !edicionIdInput || !edicionDiarioIdInput) {
                mostrarMensajeGlobal('Por favor, completa los campos requeridos.', 'error', editModalMessageEl, 3000);
                if(formEdicion) formEdicion.reportValidity();
                return;
            }
            mostrarMensajeGlobal('Guardando cambios...', 'carga', editModalMessageEl);
            
            const eventoId = edicionIdInput.value;
            const diarioIdEvento = edicionDiarioIdInput.value; // ID del diario al que pertenece el evento

            const formData = new FormData();
            formData.append('titulo', edicionTituloInput.value);
            formData.append('fecha', edicionFechaInput.value);
            formData.append('descripcion', edicionDescripcionInput.value);
            formData.append('favorito', edicionFavoritoInput.checked);
            
            const eventoOriginal = allServerEvents.find(e => e.id === parseInt(eventoId));
            if (eventoOriginal) {
                formData.append('tipo', eventoOriginal.tipo); // El tipo no se cambia en la edición de solo metadatos
                // Si no se sube nuevo archivo, enviar el media_url existente para que el backend sepa que no se borra
                if (!edicionMediaFileInput.files[0] && eventoOriginal.media_url) {
                    formData.append('media_url_existente', eventoOriginal.media_url);
                }
            } else {
                 mostrarMensajeGlobal('Error: No se encontró el evento original.', 'error', editModalMessageEl, 4000); return;
            }

            if (edicionMediaFileInput.files[0]) {
                formData.append('mediaFile', edicionMediaFileInput.files[0]);
                // IMPORTANTE: Multer en el backend (para PUT /api/eventos/:id) necesita el diarioId si se sube archivo
                formData.append('diarioId', diarioIdEvento); 
            }


            try {
                const eventoActualizado = await fetchAPI(`/api/eventos/${eventoId}`, 'PUT', formData, true); // true para FormData
                if (eventoActualizado) {
                    const index = allServerEvents.findIndex(e => e.id === parseInt(eventoId));
                    if (index !== -1) allServerEvents[index] = { ...allServerEvents[index], ...eventoActualizado, favorito: Boolean(eventoActualizado.favorito) };
                    renderizarGaleriaFiltrada();
                    cerrarModalEdicion();
                    mostrarMensajeGlobal('Cambios guardados.', 'exito', globalGalleryMessageEl, 3000);
                }
            } catch (error) {
                console.error('Error al guardar cambios:', error);
                mostrarMensajeGlobal(`Error: ${error.message}`, 'error', editModalMessageEl, 4000);
            }
        }
        async function eliminarRecuerdo(id) {
            if (!confirm('¿Estás seguro de que quieres eliminar este recuerdo?')) return;
            try {
                await fetchAPI(`/api/eventos/${id}`, 'DELETE');
                allServerEvents = allServerEvents.filter(e => e.id !== id);
                renderizarGaleriaFiltrada();
                mostrarMensajeGlobal('Recuerdo eliminado.', 'exito', globalGalleryMessageEl, 3000);
            } catch (error) {
                console.error('Error al eliminar recuerdo:', error);
                mostrarMensajeGlobal(`Error: ${error.message}`, 'error', globalGalleryMessageEl, 3000);
            }
        }
        async function toggleFavoritoRecuerdo(id, esFavoritoActual, botonEl) {
            try {
                if(botonEl) {
                    botonEl.innerHTML = !esFavoritoActual ? '★' : '☆';
                    botonEl.classList.toggle('favorito', !esFavoritoActual);
                }
                const eventoActualizado = await fetchAPI(`/api/eventos/${id}/favorito`, 'PUT', { favorito: !esFavoritoActual });
                const index = allServerEvents.findIndex(e => e.id === id);
                if (index !== -1) allServerEvents[index].favorito = Boolean(eventoActualizado.favorito);
                if (currentMediaFilter === 'favoritos') renderizarGaleriaFiltrada(); // Re-renderizar si estamos en filtro de favoritos
                // No es necesario re-renderizar toda la galería si no es filtro de favoritos, solo el botón ya se actualizó.
                mostrarMensajeGlobal('Favorito actualizado.', 'exito', globalGalleryMessageEl, 2000);
            } catch (error) {
                if(botonEl) { 
                    botonEl.innerHTML = esFavoritoActual ? '★' : '☆';
                    botonEl.classList.toggle('favorito', esFavoritoActual);
                }
                console.error('Error al actualizar favorito:', error);
                mostrarMensajeGlobal(`Error: ${error.message}`, 'error', globalGalleryMessageEl, 3000);
            }
        }

        function configurarEventosUI() {
            if(btnLogout) btnLogout.addEventListener('click', cerrarSesion);
            if(btnNuevoRecuerdo) btnNuevoRecuerdo.addEventListener('click', abrirModalRecuerdo);
            if(btnIniciarPresentacion) btnIniciarPresentacion.addEventListener('click', () => abrirPresentacion(0));
            if(btnCancelarSubida) btnCancelarSubida.addEventListener('click', cerrarModalRecuerdo);
            if(btnCancelarEdicion) btnCancelarEdicion.addEventListener('click', cerrarModalEdicion);
            
            if(formMedia) formMedia.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!formMedia.checkValidity() || !currentActiveDiarioId) { // Asegurar que hay diarioId
                    mostrarMensajeGlobal('Por favor, completa los campos requeridos y asegúrate de tener un diario activo.', 'error', uploadMessageEl, 3000);
                    formMedia.reportValidity(); return;
                }
                mostrarMensajeGlobal('Subiendo...', 'carga', uploadMessageEl);
                
                const formData = new FormData(formMedia); // FormData tomará los names de los inputs
                // El input 'nuevo-recuerdo-diario-id' ya tiene el name 'diarioId' y el valor de currentActiveDiarioId
                
                const file = mediaFileInput.files[0];
                if (!file) { mostrarMensajeGlobal('Selecciona un archivo.', 'error', uploadMessageEl, 3000); return; }
                if (file.size > 25 * 1024 * 1024) { mostrarMensajeGlobal('Archivo muy grande (máx 25MB).', 'error', uploadMessageEl, 4000); return; }
                
                let tipoEvento = file.type.startsWith('image/') ? 'foto' : (file.type.startsWith('video/') ? 'video' : '');
                if (!tipoEvento) { mostrarMensajeGlobal('Tipo de archivo no permitido.', 'error', uploadMessageEl, 3000); return; }
                formData.append('tipo', tipoEvento); // Añadir tipo al FormData

                // El campo 'favorito' es un checkbox, FormData lo maneja bien si tiene 'value' o se ajusta
                // Si el checkbox no está marcado, no se envía. Si está marcado, se envía con su valor (por defecto 'on').
                // El backend lo convierte a booleano.
                // Si se quiere ser explícito: formData.set('favorito', document.getElementById('media-favorito').checked);


                try {
                    // El endpoint /api/eventos (POST) ya espera 'diarioId' en el body (FormData)
                    await fetchAPI('/api/eventos', 'POST', formData, true); // true para FormData
                    mostrarMensajeGlobal('Recuerdo guardado!', 'exito', globalGalleryMessageEl, 3000);
                    cerrarModalRecuerdo();
                    cargarYRenderizarGaleria(); // Recargar la galería para el diario activo
                } catch (error) {
                    console.error('Error al guardar:', error);
                    mostrarMensajeGlobal(`Error: ${error.message}`, 'error', uploadMessageEl, 5000);
                }
            });

            if(formEdicion) formEdicion.addEventListener('submit', guardarCambiosEdicion);

            if(mediaFileInput) mediaFileInput.addEventListener('change', function(event) {
                const file = event.target.files[0];
                if(previewContainer) previewContainer.innerHTML = '';
                if (file) {
                    const reader = new FileReader();
                    let mediaElementPreview;
                    if (file.type.startsWith('image/')) mediaElementPreview = document.createElement('img');
                    else if (file.type.startsWith('video/')) { mediaElementPreview = document.createElement('video'); mediaElementPreview.controls = true; mediaElementPreview.muted = true; }
                    else { mostrarMensajeGlobal('Archivo no soportado para previsualización.', 'error', uploadMessageEl, 3000); return; }
                    mediaElementPreview.id = 'media-preview';
                    reader.onload = function(e) { mediaElementPreview.src = e.target.result; }
                    if(previewContainer) previewContainer.appendChild(mediaElementPreview);
                    reader.readAsDataURL(file);
                }
            });

            if(galeriaGridItems) galeriaGridItems.addEventListener('click', async (e) => {
                const itemElement = e.target.closest('.galeria-item');
                const actionButton = e.target.closest('.galeria-acciones button');
                if (actionButton) {
                    e.stopPropagation(); // Prevenir que el click en el botón también abra la presentación
                    const itemId = parseInt(actionButton.dataset.id);
                    const item = allServerEvents.find(ev => ev.id === itemId);
                    if(!item) return;
                    if (actionButton.classList.contains('btn-favorito')) await toggleFavoritoRecuerdo(item.id, item.favorito, actionButton);
                    else if (actionButton.classList.contains('btn-editar')) abrirModalEdicion(item);
                    else if (actionButton.classList.contains('btn-eliminar')) await eliminarRecuerdo(item.id);
                } else if (itemElement) {
                    const itemId = parseInt(itemElement.dataset.id);
                    const indexToShow = fullscreenableItems.findIndex(fsItem => fsItem.id === itemId);
                    if (indexToShow !== -1) abrirPresentacion(indexToShow);
                }
            });

            document.querySelectorAll('#galeria-filtros .btn-filter').forEach(button => {
                button.addEventListener('click', function() {
                    document.querySelectorAll('#galeria-filtros .btn-filter').forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    currentMediaFilter = this.dataset.filter;
                    renderizarGaleriaFiltrada();
                });
            });

            if(modalNuevoRecuerdo) modalNuevoRecuerdo.addEventListener('click', (e) => { if (e.target === modalNuevoRecuerdo) cerrarModalRecuerdo(); });
            if(modalEdicion) modalEdicion.addEventListener('click', (e) => { if (e.target === modalEdicion) cerrarModalEdicion(); });
            if(fullscreenOverlay) fullscreenOverlay.addEventListener('click', (e) => { if (e.target === fullscreenOverlay) cerrarPresentacion(); });
            if(btnFsCerrar) btnFsCerrar.addEventListener('click', cerrarPresentacion);
            if(btnFsAnterior) btnFsAnterior.addEventListener('click', () => mostrarMediaEnPresentacion(currentFsIndex - 1));
            if(btnFsSiguiente) btnFsSiguiente.addEventListener('click', () => mostrarMediaEnPresentacion(currentFsIndex + 1));
            if(btnFsPlay) btnFsPlay.addEventListener('click', toggleSlideshow);
            if(btnFsFullscreen) btnFsFullscreen.addEventListener('click', toggleVerdaderoFullscreen);

            document.addEventListener('keydown', (e) => {
                if (fullscreenOverlay && fullscreenOverlay.style.display === 'flex') {
                    switch (e.key) {
                        case 'Escape': cerrarPresentacion(); break;
                        case 'ArrowLeft': if(btnFsAnterior && !btnFsAnterior.disabled) btnFsAnterior.click(); break;
                        case 'ArrowRight': if(btnFsSiguiente && !btnFsSiguiente.disabled) btnFsSiguiente.click(); break;
                        case ' ': e.preventDefault(); if(btnFsPlay) toggleSlideshow(); break;
                        case 'f': case 'F': e.preventDefault(); if(btnFsFullscreen) toggleVerdaderoFullscreen(); break;
                    }
                } else if (e.key === 'Escape') {
                    if (modalNuevoRecuerdo && modalNuevoRecuerdo.style.display === 'flex') cerrarModalRecuerdo();
                    if (modalEdicion && modalEdicion.style.display === 'flex') cerrarModalEdicion();
                }
            });
             // Escuchar cambios en el diario activo (si se implementa un selector en otra parte)
            window.addEventListener('activeDiarioChanged', async (event) => {
                console.log('Fotos.html: Diario activo cambiado a:', event.detail.diarioId);
                mostrarMensajeGlobal('Cargando recuerdos del nuevo diario...', 'carga', globalGalleryMessageEl);
                await inicializarPaginaFotos(); // Recargar todo con el nuevo contexto del diario
                mostrarMensajeGlobal('', '', globalGalleryMessageEl);
            });
        }

        // --- INICIALIZACIÓN ---
        await inicializarPaginaFotos(); // Carga inicial de datos y configuración de UI
        configurarEventosUI(); // Configurar listeners generales de la UI
    });
    </script>
</body>
</html>
