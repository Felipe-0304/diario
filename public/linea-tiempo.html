<!DOCTYPE html>
<html lang="es" id="html-theme">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Revisa la cronolog√≠a de todos los momentos especiales y el desarrollo de tu beb√©">
    <meta name="theme-color" content="#FFB6C1">
    <title>Mi Peque√±o Tesoro - L√≠nea de Tiempo</title>
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&family=Comic+Neue:wght@400;700&family=Roboto:wght@400;700&family=Open+Sans:wght@400;700&family=Dancing+Script:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/main.css"> 
    <style>
    :root {
        --color-primario: #FFB6C1;
        --color-secundario: #FFD1DC;
        --color-accento: #FFD700;
        --color-texto: #5D3B45;
        --color-texto-claro: #A78B94;
        --color-fondo: #FFF9FB;
        --color-tarjetas: #FFFFFF;
        --color-bordes: #F0D6DE;
        --color-error: #ff6b6b;
        --color-exito: #28a745;

        --color-hito: #9370DB;
        --color-vacuna: #CD5C5C;
        --color-evento: #FFA500;
        --color-control: #2E8B57;
        --color-foto: #ff9800; 
        --color-video: #795548; 
        --fuente-principal: 'Comic Neue', cursive;
        --tamano-fuente: 16px;
    }

    body {
        font-family: var(--fuente-principal);
        background-color: var(--color-fondo);
        color: var(--color-texto);
        margin: 0;
        padding: 0;
        line-height: 1.6;
        font-size: var(--tamano-fuente);
    }

    .container { max-width: 800px; margin: 0 auto; padding: 20px; }
    header { text-align: center; margin-bottom: 30px; position: relative; }
    h1#titulo-principal-timeline { font-family: 'Pacifico', cursive; color: var(--color-primario); font-size: 2.5rem; margin-bottom: 20px; }
   
    .filtros { display: flex; justify-content: center; flex-wrap: wrap; gap: 10px; margin-bottom: 25px; }
    .btn { padding: 10px 20px; border: none; border-radius: 25px; font-family: var(--fuente-principal); font-weight: bold; cursor: pointer; transition: all 0.3s; }
    .btn-filtro { background-color: var(--color-fondo); color: var(--color-texto); border: 1px solid var(--color-bordes); }
    .btn-filtro:hover { background-color: var(--color-secundario); }
    .btn-filtro.active { background-color: var(--color-primario); color: white; border-color: var(--color-primario); }
    .buscador { margin: 0 auto 25px; max-width: 500px; }
    .form-control { width: 100%; padding: 12px 15px; border: 1px solid var(--color-bordes); border-radius: 25px; font-family: var(--fuente-principal); font-size: 1rem; transition: all 0.3s; box-sizing: border-box; }
    .form-control:focus { outline: none; border-color: var(--color-primario); box-shadow: 0 0 0 2px var(--color-secundario); }

    .linea-tiempo { position: relative; padding: 20px 0; }

    .linea-tiempo::before {
        content: '';
        position: absolute;
        top: 0;
        left: 50%;
        transform: translateX(-50%);
        width: 3px;
        height: 100%;
        background-color: var(--color-bordes);
        border-radius: 3px;
    }

    .evento-item {
        position: relative;
        width: calc(50% - 40px); 
        margin-bottom: 40px;
        background-color: var(--color-tarjetas);
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        transition: all 0.4s ease;
        opacity: 0;
        transform: translateY(30px);
    }
    
    .evento-item.visible {
        opacity: 1;
        transform: translateY(0);
    }

    .evento-item:nth-child(odd) {
        align-self: flex-end;
        border-left: 5px solid; 
    }

    .evento-item:nth-child(even) {
        align-self: flex-start;
        border-right: 5px solid; 
    }

    .evento-item::before {
        content: ''; 
        position: absolute;
        top: 20px;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-color: var(--color-fondo);
        border: 3px solid; 
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem; 
        z-index: 1;
    }

    .evento-item::after {
        content: '';
        position: absolute;
        top: 28px;
        width: 0;
        height: 0;
        border-style: solid;
    }

    .evento-item:nth-child(odd) { left: 40px; }
    .evento-item:nth-child(odd)::before {
        left: -61px; 
    }
    .evento-item:nth-child(odd)::after {
        left: -15px;
        border-width: 8px 15px 8px 0;
        border-color: transparent var(--color-tarjetas) transparent transparent;
    }

    .evento-item:nth-child(even) { right: 40px; }
    .evento-item:nth-child(even)::before {
        right: -61px;
    }
    .evento-item:nth-child(even)::after {
        right: -15px;
        border-width: 8px 0 8px 15px;
        border-color: transparent transparent transparent var(--color-tarjetas);
    }

    .evento-item.foto { border-color: var(--color-foto); }
    .evento-item.foto::before { content: 'üñºÔ∏è'; border-color: var(--color-foto); }

    .evento-item.video { border-color: var(--color-video); }
    .evento-item.video::before { content: 'üé¨'; border-color: var(--color-video); }
    
    .evento-item.hito { border-color: var(--color-hito); }
    .evento-item.hito::before { content: 'üë∂'; border-color: var(--color-hito); }

    .evento-item.vacuna { border-color: var(--color-vacuna); }
    .evento-item.vacuna::before { content: 'üíâ'; border-color: var(--color-vacuna); }

    .evento-item.evento { border-color: var(--color-evento); }
    .evento-item.evento::before { content: 'üóìÔ∏è'; border-color: var(--color-evento); }
    
    .evento-item.control { border-color: var(--color-control); }
    .evento-item.control::before { content: 'ü©∫'; border-color: var(--color-control); }


    .evento-item.favorito {
        box-shadow: 0 4px 15px var(--color-accento), 0 0 0 3px var(--color-accento);
    }
    
    .evento-item.destacado {
        animation: highlightFade 2.5s ease-out;
    }
    @keyframes highlightFade {
        0%, 70% { background-color: var(--color-secundario); transform: scale(1.03); }
        100% { background-color: var(--color-tarjetas); transform: scale(1); }
    }

    .evento-fecha { font-weight: bold; color: var(--color-texto-claro); font-size: 0.9rem; margin-bottom: 8px; }
    .evento-titulo { font-size: 1.3rem; font-weight: bold; color: var(--color-texto); margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
    .evento-descripcion { margin-bottom: 15px; color: var(--color-texto); line-height: 1.7; white-space: pre-wrap; }
    .evento-media-container { margin-top: 15px; text-align: center; }
    .evento-imagen, .evento-video { max-width: 100%; max-height: 400px; border-radius: 10px; border: 2px solid var(--color-bordes); object-fit: contain; }
    .evento-video { background-color: #000; }
    
    .btn-toggle-favorito { background: none; border: none; font-size: 1.8rem; cursor: pointer; color: var(--color-texto-claro); transition: all 0.3s; padding: 0 5px; }
    .btn-toggle-favorito:hover { transform: scale(1.2); color: var(--color-accento); }
    .btn-toggle-favorito.favorito { color: var(--color-accento); animation: pulse 0.6s; }
    @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.3); } 100% { transform: scale(1); } }
    
    #timeline-loader {
        padding: 20px;
        text-align: center;
        font-weight: bold;
        color: var(--color-texto-claro);
    }

    @media (max-width: 768px) {
        .linea-tiempo::before { left: 20px; }
        .evento-item {
            width: calc(100% - 60px); 
            margin-left: 40px;
            align-self: flex-start !important;
            border-right: none !important;
            border-left: 5px solid !important;
        }
        .evento-item:nth-child(odd), .evento-item:nth-child(even) {
            left: 0; right: auto;
        }
        .evento-item::before, .evento-item:nth-child(even)::before, .evento-item:nth-child(odd)::before {
            left: -39px;
            right: auto;
        }
        .evento-item::after, .evento-item:nth-child(even)::after, .evento-item:nth-child(odd)::after {
            left: -15px;
            border-width: 8px 15px 8px 0;
            border-color: transparent var(--color-tarjetas) transparent transparent;
        }
    }

    footer { text-align: center; margin-top: 50px; padding-top: 20px; border-top: 1px solid var(--color-bordes); color: var(--color-texto-claro); font-size: 0.9rem; }
    
    .diario-activo-timeline-info {
        text-align: right;
        margin-bottom: 10px;
        font-size: 0.85em;
        color: var(--color-texto-claro);
    }
    .diario-activo-timeline-info strong {
        color: var(--color-texto);
        font-weight: bold;
    }

</style>
</head>
<body>
    <div class="container">
        <header>
            <h1 id="titulo-principal-timeline">‚è≥ L√≠nea de Tiempo</h1>
            <button id="btn-logout" title="Cerrar sesi√≥n" style="position: absolute; top: 20px; right: 20px; background: none; border: none; cursor: pointer; font-size: 1.5rem; color: var(--color-primario);">üëã</button>
            <nav>
                <ul>
                    <li><a href="index.html">üè† Inicio</a></li>
                    <li><a href="fotos.html">üì∑ Fotos</a></li>
                    <li><a href="calendario.html">üìÖ Calendario</a></li>
                    <li><a href="linea-tiempo.html" class="active">‚è≥ L√≠nea de Tiempo</a></li>
                    <li><a href="configuracion.html">‚öôÔ∏è Configuraci√≥n</a></li>
                </ul>
            </nav>
        </header>

        <div class="diario-activo-timeline-info" id="diario-activo-timeline-info" style="display:none;">
            L√≠nea de tiempo del diario: <strong id="nombre-diario-actual-timeline">Cargando...</strong>
        </div>

        <div class="filtros">
            <button class="btn btn-filtro active" data-filtro="todos">Todos</button>
            <button class="btn btn-filtro" data-filtro="favoritos">‚≠ê Favoritos</button>
            <button class="btn btn-filtro" data-filtro="foto">üñºÔ∏è Fotos</button>
            <button class="btn btn-filtro" data-filtro="video">üé¨ Videos</button>
            <button class="btn btn-filtro" data-filtro="evento">üóìÔ∏è Eventos</button>
            <button class="btn btn-filtro" data-filtro="vacuna">üíâ Vacunas</button>
            <button class="btn btn-filtro" data-filtro="hito">üë∂ Hitos</button>
            <button class="btn btn-filtro" data-filtro="control">ü©∫ Controles</button>
        </div>

        <div class="buscador">
            <input type="search" id="busqueda-timeline" class="form-control" placeholder="Buscar en la l√≠nea de tiempo...">
        </div>
        
        <div id="global-timeline-message" class="mensaje" style="display:none;"></div>

        <div id="linea-tiempo-container">
            <div class="linea-tiempo" id="linea-tiempo-principal">
                <p class="mensaje mensaje-carga">Cargando recuerdos...</p> 
            </div>
            <div id="timeline-loader" style="display:none;">Cargando m√°s recuerdos...</div>
        </div>

        <footer>
            <p>&copy; <span id="current-year"></span> Con todo el amor del mundo - Diario de Mi Beb√© </p>
        </footer>
    </div>

    <script src="/js/theme-manager.js" defer></script>
    <script src="/js/utils.js" defer></script>
    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            const lineaTiempoEl = document.getElementById('linea-tiempo-principal');
            const busquedaInput = document.getElementById('busqueda-timeline');
            const btnLogout = document.getElementById('btn-logout');
            const botonesFiltro = document.querySelectorAll('.btn-filtro');
            const globalTimelineMessageEl = document.getElementById('global-timeline-message');
            const tituloPrincipalTimelineEl = document.getElementById('titulo-principal-timeline');
            const diarioActivoInfoEl = document.getElementById('diario-activo-timeline-info');
            const nombreDiarioActualEl = document.getElementById('nombre-diario-actual-timeline');
            const loaderEl = document.getElementById('timeline-loader');
            
            let todosLosEventos = [];
            let filtroActual = 'todos';
            let terminoBusquedaActual = '';
            let currentActiveDiarioId = null;

            // --- OPTIMIZACI√ìN DE PAGINACI√ìN ---
            let paginaActual = 1;
            let totalPaginas = 1;
            let estaCargando = false;

            async function inicializarPaginaTimeline() {
                currentActiveDiarioId = getActiveDiarioId();

                if (!currentActiveDiarioId) {
                    mostrarMensajeGlobal('No hay un diario activo. Por favor, ve a Inicio.', 'error', globalTimelineMessageEl);
                    if(lineaTiempoEl) lineaTiempoEl.innerHTML = '<p class="mensaje mensaje-vacio">Selecciona un diario para ver su l√≠nea de tiempo.</p>';
                    if(diarioActivoInfoEl) diarioActivoInfoEl.style.display = 'none';
                    botonesFiltro.forEach(b => b.disabled = true);
                    if(busquedaInput) busquedaInput.disabled = true;
                    return;
                }
                
                botonesFiltro.forEach(b => b.disabled = false);
                if(busquedaInput) busquedaInput.disabled = false;

                if (diarioActivoInfoEl && nombreDiarioActualEl && tituloPrincipalTimelineEl) {
                    try {
                        const configDiario = await fetchAPI('/api/configuracion');
                        if (configDiario) {
                            const nombreDiario = configDiario.nombre_diario_personalizado || `Diario ID: ${currentActiveDiarioId}`;
                            nombreDiarioActualEl.textContent = nombreDiario;
                            tituloPrincipalTimelineEl.textContent = `‚è≥ L√≠nea de Tiempo de ${nombreDiario}`;
                            document.title = `L√≠nea de Tiempo - ${nombreDiario}`;
                        }
                        diarioActivoInfoEl.style.display = 'block';
                    } catch (error) {
                        console.warn("No se pudo cargar el nombre del diario para timeline:", error.message);
                        nombreDiarioActualEl.textContent = `Diario ID: ${currentActiveDiarioId}`;
                        tituloPrincipalTimelineEl.textContent = `‚è≥ L√≠nea de Tiempo del Diario ID: ${currentActiveDiarioId}`;
                        diarioActivoInfoEl.style.display = 'block';
                    }
                }
                
                await resetYCargarEventos();
            }

            async function resetYCargarEventos() {
                todosLosEventos = [];
                paginaActual = 1;
                totalPaginas = 1;
                lineaTiempoEl.innerHTML = '';
                await cargarEventosDeAPI();
            }


            function configurarEventListeners() {
                botonesFiltro.forEach(boton => {
                    boton.addEventListener('click', function() {
                        if (this.disabled) return;
                        botonesFiltro.forEach(b => b.classList.remove('active'));
                        this.classList.add('active');
                        filtroActual = this.dataset.filtro;
                        renderizarEventosFiltrados();
                    });
                });
                
                let debounceTimer;
                if(busquedaInput) {
                    busquedaInput.addEventListener('input', function() {
                        if (this.disabled) return;
                        clearTimeout(debounceTimer);
                        debounceTimer = setTimeout(() => {
                            terminoBusquedaActual = this.value.toLowerCase().trim();
                            // La b√∫squeda ahora solo filtra los eventos ya cargados en el cliente
                            renderizarEventosFiltrados();
                        }, 300); 
                    });
                }
                
                if(btnLogout) btnLogout.addEventListener('click', cerrarSesion);

                if(lineaTiempoEl) {
                    lineaTiempoEl.addEventListener('click', async (e) => {
                        const target = e.target.closest('.btn-toggle-favorito');
                        if (target) {
                            const eventoId = parseInt(target.dataset.id);
                            const evento = todosLosEventos.find(ev => ev.id === eventoId);
                            if (evento) {
                                await toggleFavoritoEnTimeline(evento, target);
                            }
                        }
                    });
                }

                window.addEventListener('activeDiarioChanged', async (event) => {
                    console.log('Linea-tiempo.html: Diario activo cambiado a:', event.detail.diarioId);
                    mostrarMensajeGlobal('Cargando l√≠nea de tiempo del nuevo diario...', 'carga', globalTimelineMessageEl);
                    await inicializarPaginaTimeline(); 
                    mostrarMensajeGlobal('', '', globalTimelineMessageEl);
                });
            }
            
            async function cargarEventosDeAPI() {
                if (!currentActiveDiarioId || estaCargando || paginaActual > totalPaginas) {
                    return;
                }
                
                estaCargando = true;
                if (loaderEl) loaderEl.style.display = 'block';
                if (paginaActual === 1) {
                    mostrarMensajeGlobal('Cargando recuerdos...', 'carga', lineaTiempoEl);
                }
                
                try {
                    const url = `/api/eventos/diario/${currentActiveDiarioId}?page=${paginaActual}&limit=20`;
                    const data = await fetchAPI(url);
                    
                    if (paginaActual === 1) {
                        lineaTiempoEl.innerHTML = '';
                        todosLosEventos = [];
                    }

                    const nuevosEventos = data.eventos || [];
                    todosLosEventos.push(...nuevosEventos);
                    totalPaginas = data.totalPages || 1;
                    
                    renderizarEventosFiltrados();
                    paginaActual++;

                } catch (error) {
                    console.error('Error cargando eventos para timeline:', error);
                     if (error.message !== 'No autorizado') {
                        mostrarMensajeGlobal(`Error al cargar: ${error.message}`, 'error', globalTimelineMessageEl);
                    }
                } finally {
                    estaCargando = false;
                    if (loaderEl) loaderEl.style.display = 'none';
                }
            }
            
            async function toggleFavoritoEnTimeline(evento, botonEl) {
                if (!globalTimelineMessageEl) return;
                const esFavoritoOriginal = evento.favorito;
                try {
                    evento.favorito = !esFavoritoOriginal;
                    if (botonEl) {
                        botonEl.innerHTML = evento.favorito ? '‚òÖ' : '‚òÜ';
                        botonEl.classList.toggle('favorito', evento.favorito);
                        botonEl.closest('.evento-item')?.classList.toggle('favorito', evento.favorito);
                    }

                    const eventoActualizado = await fetchAPI(`/api/eventos/${evento.id}/favorito`, 'PUT', { favorito: evento.favorito });
                    
                    const index = todosLosEventos.findIndex(e => e.id === evento.id);
                    if (index !== -1) todosLosEventos[index].favorito = Boolean(eventoActualizado.favorito);

                    if (filtroActual === 'favoritos') renderizarEventosFiltrados();
                    
                    mostrarMensajeGlobal('Favorito actualizado.', 'exito', globalTimelineMessageEl, 2000);

                } catch (error) {
                    evento.favorito = esFavoritoOriginal;
                     if (botonEl) {
                        botonEl.innerHTML = evento.favorito ? '‚òÖ' : '‚òÜ';
                        botonEl.classList.toggle('favorito', evento.favorito);
                        botonEl.closest('.evento-item')?.classList.toggle('favorito', evento.favorito);
                    }
                    console.error('Error al actualizar favorito en timeline:', error);
                    mostrarMensajeGlobal(`Error al actualizar favorito: ${error.message}`, 'error', globalTimelineMessageEl, 3000);
                }
            }
            
            const timelineObserver = new IntersectionObserver((entries, observer) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('visible');
                        const img = entry.target.querySelector('.evento-imagen[data-src]');
                        if (img) {
                            img.src = img.dataset.src;
                            img.removeAttribute('data-src'); 
                        }
                        observer.unobserve(entry.target);
                    }
                });
            }, { 
                rootMargin: '0px',
                threshold: 0.1 
            });

            function crearElementoTimeline(evento) {
                const elemento = document.createElement('div');
                elemento.className = `evento-item ${evento.tipo || 'evento'} ${evento.favorito ? 'favorito' : ''}`;
                elemento.id = `evento-${evento.id}`; 
                
                const fechaFormateada = new Date(evento.fecha + 'T00:00:00Z').toLocaleDateString('es-ES', {
                    year: 'numeric', month: 'long', day: 'numeric', timeZone: 'UTC'
                });
                
                let mediaHtml = '';
                if (evento.media_url) {
                    if (evento.tipo === 'foto') {
                        mediaHtml = `<img data-src="${evento.media_url}" alt="${evento.titulo}" class="evento-imagen" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7">`;
                    } else if (evento.tipo === 'video') {
                        mediaHtml = `<video src="${evento.media_url}" controls class="evento-video" preload="metadata"></video>`;
                    }
                }
                
                elemento.innerHTML = `
                    <div class="evento-fecha">${fechaFormateada}</div>
                    <div class="evento-titulo">
                        <span>${evento.titulo || 'Evento sin t√≠tulo'}</span>
                        <button class="btn-toggle-favorito ${evento.favorito ? 'favorito' : ''}" data-id="${evento.id}" title="${evento.favorito ? 'Quitar favorito' : 'Marcar favorito'}">
                            ${evento.favorito ? '‚òÖ' : '‚òÜ'}
                        </button>
                    </div>
                    ${evento.descripcion ? `<div class="evento-descripcion">${evento.descripcion}</div>` : ''}
                    ${mediaHtml ? `<div class="evento-media-container">${mediaHtml}</div>` : ''}
                `;
                return elemento;
            }
            
            function renderizarEventosFiltrados() {
                if (!lineaTiempoEl) return;
                let eventosParaMostrar = todosLosEventos;
                
                if (filtroActual !== 'todos') {
                    if (filtroActual === 'favoritos') {
                        eventosParaMostrar = eventosParaMostrar.filter(e => e.favorito);
                    } else {
                        eventosParaMostrar = eventosParaMostrar.filter(e => e.tipo === filtroActual);
                    }
                }
                
                if (terminoBusquedaActual) {
                    eventosParaMostrar = eventosParaMostrar.filter(e => 
                        (e.titulo && e.titulo.toLowerCase().includes(terminoBusquedaActual)) ||
                        (e.descripcion && e.descripcion.toLowerCase().includes(terminoBusquedaActual))
                    );
                }
                
                lineaTiempoEl.innerHTML = ''; 
                if (eventosParaMostrar.length === 0) {
                    const mensajeVacio = todosLosEventos.length === 0 ? 
                        'A√∫n no has a√±adido ning√∫n recuerdo a este diario. ¬°Empieza ahora!' : 
                        'No hay eventos que coincidan con tus filtros o b√∫squeda en este diario.';
                    mostrarMensajeGlobal(mensajeVacio, 'vacio', lineaTiempoEl);
                    return;
                }
                
                eventosParaMostrar.forEach(evento => {
                    const elemento = crearElementoTimeline(evento);
                    lineaTiempoEl.appendChild(elemento);
                    timelineObserver.observe(elemento);
                });

                procesarHashUrl();
            }

            const loaderObserver = new IntersectionObserver((entries) => {
                if (entries[0].isIntersecting && !estaCargando) {
                    cargarEventosDeAPI();
                }
            }, { threshold: 1.0 });

            if (loaderEl) {
                loaderObserver.observe(loaderEl);
            }

            function procesarHashUrl() {
                if (window.location.hash) {
                    const elementoId = window.location.hash.substring(1); 
                    const elemento = document.getElementById(elementoId);
                    if (elemento) {
                        setTimeout(() => { 
                            elemento.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            elemento.classList.add('destacado');
                        }, 100);
                    }
                }
            }
            
            configurarEventListeners();
            await inicializarPaginaTimeline();
        });
    </script>
</body>
</html>
